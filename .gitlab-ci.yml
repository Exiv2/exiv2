# default build for all distros
# only create artifacts of the build directory when something fails (for cmake logs)
# cache the ccache/ directory for each job separately
.build_template: &distro_build
  script:
    - python3 ci/test_build.py
  artifacts:
    when: on_failure
    paths:
      - build/
  cache:
    key: "$CI_JOB_NAME"
    paths:
      - ccache/

Fedora:
  image: fedora:28
  before_script:
    - dnf -y --refresh install gcc-c++ clang cmake make ccache expat-devel zlib-devel libssh-devel libcurl-devel gtest-devel which dos2unix
  <<: *distro_build

Debian:
  image: debian:9
  before_script:
    - apt-get update
    - apt-get install -y cmake g++ clang make ccache python3 libexpat1-dev zlib1g-dev libssh-dev libcurl4-openssl-dev libgtest-dev libxml2-utils
    - ./ci/debian_build_gtest.sh
  <<: *distro_build

Archlinux:
  image: base/archlinux
  before_script:
    - pacman --noconfirm -Sy
    - pacman --noconfirm -S gcc clang cmake make ccache expat zlib libssh curl gtest python dos2unix
  <<: *distro_build

Ubuntu:
  image: ubuntu:18.04
  before_script:
    - apt-get update
    - apt-get install -y cmake g++ clang make ccache python3 libexpat1-dev zlib1g-dev libssh-dev libcurl4-openssl-dev libgtest-dev google-mock libxml2-utils
    - ./ci/debian_build_gtest.sh
  <<: *distro_build

CentOS:
  image: centos:7
  before_script:
    - yum -y install yum-plugin-copr epel-release
    # enable copr for gtest
    - yum -y copr enable defolos/devel
    - yum clean all
    - yum -y install gcc-c++ clang cmake3 make ccache expat-devel zlib-devel libssh-devel libcurl-devel gtest-devel which python36 dos2unix
    # symlink up to date versions of python & cmake to 'default' names
    - ln -s /usr/bin/python36 /usr/bin/python3
    - mv /bin/cmake /bin/.cmake.old
    - ln -s /bin/cmake3 /bin/cmake
  <<: *distro_build

OpenSUSE:
  image: opensuse:tumbleweed
  before_script:
    - zypper --non-interactive refresh
    - zypper --non-interactive install gcc-c++ clang cmake make ccache libexpat-devel zlib-devel libssh-devel libcurl-devel gtest which dos2unix libxml2-tools
  <<: *distro_build
